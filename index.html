<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Deneme</title>
</head>
  <body>
    <h1>Bionluk Roblox</h1>
    <a class="alert"></a>
    <div id="webrtcWrap" class="webrtc-wrap">
      <video
        id="webrtc"
        autoplay
        controls
        playsinline
        webkit-playsinline="true"
        disablepictureinpicture=""
        x-webkit-airplay="allow"
        x5-video-player-type="h5"
        x5-video-player-fullscreen="true"
        x5-video-orientation="portrait"
        style="width: 415.327px; height: 738.359px; left: 0px; top: 0px;"
      ></video>
      </div>
    </div>
  </body> 
  <script>
    let queueInterval;

    fetch("token.php")
      .then((response) => response.json())
      .then((tokenData) => {
        var ws = new WebSocket(tokenData.data.socket);
        var pc;
        var dataChannel;
        var deviceWidth = 720; // Varsayılan genişlik
        var deviceHeight = 1280; // Varsayılan yükseklik

        ws.onopen = function () {
          ws.onmessage = function (event) {
            const parsedData = JSON.parse(event.data);

            if (parsedData.code === 8002) {
              const alert = document.querySelector(".alert");
              alert.innerHTML =
                "Tüm cihazlar dolu. Mevcut sıranız: " +
                parsedData.data.queueValue;

              ws.send(JSON.stringify({ type: "queue" }));
            }

            if (parsedData.code === 8011) {
              const alert = document.querySelector(".alert");
              alert.innerHTML =
                "Tüm cihazlar dolu. Mevcut sıranız: " +
                parsedData.data.queueValue;

              if (parsedData.data.queueValue === null) {
                window.location.reload();
              }

              ws.send(JSON.stringify({ type: "queue" }));
            }

            if (parsedData.code === 8888) {
              if (queueInterval) {
                clearInterval(queueInterval);
                console.log("Queue interval durduruldu.");
                const alert = document.querySelector(".alert");
                alert.innerHTML = "";
              }

              fetch(
                "info.php?deviceId=" + parsedData.data.deviceId
              )
                .then((response) => response.json())
                .then((deviceData) => {
                  const publicIp = deviceData.data.data.publicIp;
                  const accessPort = deviceData.data.data.accessPort;
                  const deviceWss = parsedData.data.deviceWss;

                  if (!publicIp || !accessPort) {
                    console.error("Public IP veya Access Port tanımsız.");
                    return;
                  }

                  var deviceSocket = new WebSocket(deviceWss);
                  deviceSocket.onopen = function () {
                    console.log(
                      "deviceWss WebSocket bağlantısı kuruldu:",
                      deviceWss
                    );

                    const joinMessage = {
                      eventType: "1",
                      eventName: "_join",
                      data: {
                        uid: parsedData.data.uid,
                        token: tokenData.data.data.token,
                        authparams: JSON.stringify({
                          deviceId: parsedData.data.deviceId,
                          token: tokenData.data.data.token,
                          uid: parsedData.data.uid,
                        }),
                        browser_name: "opera",
                        browser_ver: "112.0.0.0",
                        cloudgame_cfg: {
                          gameId: 1,
                          packageName: "com.roblox.client",
                          minutes: 99999,
                        },
                        phoneId: deviceData.data.data.phoneId,
                        phone_os: "windows",
                        phone_ver: "10",
                        quality: 2,
                        sys_locale: "en-US",
                        type: 0,
                        user_agent:
                          "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36 OPR/112.0.0.0",
                      },
                    };

                    deviceSocket.send(JSON.stringify(joinMessage));
                    console.log("Join mesajı gönderildi:", joinMessage);

                    setInterval(() => {
                      deviceSocket.send(
                        JSON.stringify({
                          eventType: "1",
                          eventName: "_ping",
                          data: {},
                        })
                      );
                    }, 15000);
                  };

                  deviceSocket.onmessage = function (message) {
                    const deviceSData = JSON.parse(message.data);

                    // Eğer cihaz boyutlarıyla ilgili bilgi gelirse güncelle
                    if (
                      deviceSData.eventName === "_notify" &&
                      deviceSData.data.type === 0
                    ) {
                      deviceWidth = deviceSData.data.x;
                      deviceHeight = deviceSData.data.y;
                      console.log(
                        `Cihaz boyutları güncellendi: ${deviceWidth}x${deviceHeight}`
                      );
                    }

                    if (
                      deviceSData.eventName === "_join_res" &&
                      deviceSData.data.code === 0
                    ) {
                      console.log("Oturum başarıyla katıldı:", deviceSData);

                      fetch("trace.php", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                          client_ip: "",
                          //client_report_time mevcut tarihin timestamp
                          client_report_time: `${+new Date()}`,
                          connect_ws_ok: 2,
                          create_offer_ok: 2,
                          device_id: parsedData.data.deviceId,
                          game_id: "20240430",
                          join_res_ok: 2,
                          page_url: "https://www.easyfun.gg/games/roblox.html",
                          playing_ok: 1,
                          remark: JSON.stringify({
                            uid: parsedData.data.uid,
                            videostatus: "playing-666",
                          }),
                          sdk_info: JSON.stringify({
                            version: "20240605-1",
                            remark: "2024年06月05日09:44:19，画质切换",
                          }),
                          set_local_description_ok: 2,
                          set_remote_description_ok: 2,
                          useragent:
                            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36 OPR/112.0.0.0",
                          ws_url: deviceWss,
                          statistics: JSON.stringify({
                            supportRTC: true,
                            dtlsTransportState: "connected",
                            rttArr: [],
                            lossArr: [],
                            trackEvent: {
                              track: true,
                              ontrack: false,
                              addstream: true,
                              addtrack: false,
                            },
                            candidate: [],
                            mutedRecord: ["loadedmetadata-true"],
                            joinRes: JSON.stringify({
                              code: deviceSData.data.code,
                              msg: deviceSData.data.msg,
                              rotation: deviceSData.data.rotation,
                              x: deviceSData.data.x,
                              y: deviceSData.data.y,
                            }),
                          }),
                          progress_info:
                            '[{"progress":0,"time":1725613546020},{"progress":1,"time":1725613546038},{"progress":2,"time":1725613546042},{"progress":3,"time":1725613546045},{"progress":5,"time":1725613546045},{"progress":6,"time":1725613546733},{"progress":4,"time":1725613547920},{"progress":7,"time":1725613548822},{"progress":8,"time":1725613548830},{"progress":9,"time":1725613549068},{"progress":10,"time":1725613549070},{"progress":60,"time":1725613549078},{"progress":80,"time":1725613550965},{"progress":70,"time":1725613550966},{"progress":81,"time":1725613550966},{"progress":90,"time":1725613550972}]',
                        }),
                      })
                        .then((response) => response.json())
                        .then((traceData) => {
                          console.log("Trace verisi gönderildi:", traceData);
                        })
                        .catch((error) => {
                          console.error(
                            "Trace verisi gönderilirken hata:",
                            error
                          );
                        });

                      // PeerConnection ve DataChannel oluşturma
                      if (!pc) {
                        pc = new RTCPeerConnection({
                          iceServers: [],
                        });

                        dataChannel = pc.createDataChannel("MessageChannel", {
                          ordered: true,
                        });

                        dataChannel.onopen = (event) => {
                          console.log("DataChannel bağlantısı açıldı:", event);
                        };

                        dataChannel.onmessage = (event) => {
                          console.log("DataChannel mesajı alındı:", event.data);
                        };

                        dataChannel.onerror = (error) => {
                          console.error("DataChannel hatası:", error);
                        };

                        pc.addTransceiver("video", { direction: "recvonly" });
                        pc.addTransceiver("audio", { direction: "recvonly" });

                        pc.onicecandidate = (event) => {
                          console.log("ICE Adayı oluşturuldu:", event.candidate);
                          //if (event.candidate) {
                            const candidateMessage = {
                              eventType: "1",
                              eventName: "_candidate",
                              data: {
                                candidate: event.candidate,
                                sdpMid: "0",
                                sdpMLineIndex: 0,
                              },
                            };
                            deviceSocket.send(JSON.stringify(candidateMessage));
                            console.log(
                              "ICE Adayı gönderildi:",
                              candidateMessage
                            );
                          //}
                        };

                        pc.createOffer()
                          .then((offer) => {
                            pc.setLocalDescription(offer);

                            const offerMessage = {
                              eventType: "1",
                              eventName: "_offer",
                              data: {
                                sdp: { type: "offer", sdp: offer.sdp },
                                preferred_tcp: false,
                              },
                            };

                            deviceSocket.send(JSON.stringify(offerMessage));
                            console.log("Offer gönderildi:", offerMessage);
                          })
                          .catch((err) => {
                            console.error("Offer oluşturulurken hata:", err);
                          });

                        pc.ontrack = (event) => {
                          const video = document.getElementById("webrtc");
                          video.srcObject = event.streams[0];
                        };

                        pc.onaddstream = (event) => {
                          const video = document.getElementById("webrtc");
                          video.srcObject = event.stream;
                        };
                      }

                      pc.ondatachannel = (event) => {
                        //dataChannel = event.channel;
                        dataChannel.onopen = (event) => {
                          console.log("DataChannel bağlantısı açıldı:", event.channel);
                        };

                        dataChannel.onmessage = (event) => {
                          console.log("DataChannel mesajı alındı:", event.data);
                        };

                        dataChannel.onerror = (error) => {
                          console.error("DataChannel hatası:", error);
                        };
                      };

                      

                      const videoElement = document.getElementById("webrtc");
                      const webrtcWrap = document.getElementById("webrtcWrap");

                      // Click event listener for the container wrapping the video element
                      webrtcWrap.addEventListener("click", (e) => {
  const rect = videoElement.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  // Gerçek cihaz boyutlarına göre ölçekleme
  const scaleX = deviceWidth / rect.width;
  const scaleY = deviceHeight / rect.height;
  const scaledX = Math.floor(x * scaleX);
  const scaledY = Math.floor(y * scaleY);

  const newestData = {
    eventType: "1",
    eventName: "_touch2",
    data: {
      type: 0,
      x: Number(scaledX),  // Çıkarma işlemi yapmaya gerek yok
      y: Number(scaledY),
    },
  };

  if (dataChannel && dataChannel.readyState === "open") {
    dataChannel.send(JSON.stringify(newestData));
    console.log("Tıklama gönderildi:", newestData);
  } else {
    console.error("DataChannel hazır değil.");
  }
});

                    }

                    if (
                      deviceSData.eventName === "_answer" &&
                      deviceSData.data.sdp
                    ) {
                      let remoteSDP = deviceSData.data.sdp.sdp.split("\r\n");

                      remoteSDP = remoteSDP.filter(
                        (line) =>
                          !line.includes(
                            "msid:zlmediakit-mslabel zlmediakit-label"
                          )
                      );

                      const M = {
                        publicIp: publicIp,
                        accessPort: Number(accessPort) + 2,
                      };

                      remoteSDP = remoteSDP.map((line) => {
                        if (line.match("candidate")) {
                          const parts = line.split(" ");
                          parts[4] = M.publicIp;
                          parts[5] = `${M.accessPort}`;
                          return parts.join(" ");
                        }
                        return line;
                      });

                      remoteSDP = remoteSDP.join("\r\n");

                      pc.setRemoteDescription(
                        new RTCSessionDescription({
                          type: "answer",
                          sdp: remoteSDP,
                        })
                      )
                        .then(() => {
                          console.log("Remote SDP başarıyla ayarlandı.");
                        })
                        .catch((err) => {
                          console.error(
                            "Remote SDP ayarlanırken hata oluştu:",
                            err
                          );
                        });
                    }

                    if (
                      deviceSData.eventName === "_candidate" &&
                      deviceSData.data.candidate
                    ) {
                      let candidate = new RTCIceCandidate({
                        candidate: deviceSData.data.candidate,
                      });

                      pc.addIceCandidate(candidate)
                        .then(() => {
                          console.log("ICE Adayı başarıyla eklendi.");
                        })
                        .catch((err) => {
                          console.error("ICE Adayı eklenirken hata:", err);
                        });
                    }
                  };

                  deviceSocket.onerror = function (error) {
                    console.error("deviceWss WebSocket hata:", error);
                  };
                });
            }
          };

          setInterval(() => {
            ws.send(JSON.stringify({ type: "ping", data: "ping" }));
          }, 15000);
        };
      })
      .catch((error) => {
        console.error("Hata:", error);
      });
  </script>
</html>
